(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{546:function(s,a,t){"use strict";t.r(a);var e=t(6),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"原理"}},[s._v("原理")]),s._v(" "),t("p",[s._v("为主节点master 配置一个节点 slave，不管slave 是否为第一次连接上 master，slave 都会发送一个sync 命令给master 请求复制数据。")]),s._v(" "),t("p",[s._v("master接受到sync 命令后，会在后头进行数据持久化，通过"),t("code",[s._v("bgsave")]),s._v(" 生成最新的rdb 快照文件，在生成 rdb快照期间 master 如果收到客户端的更新请求，master 会把这些修改的请求缓存在内存中。")]),s._v(" "),t("p",[s._v("当持久化进行完毕之后，master 会把这份rdb文件数据集发送到slave，slave会把接收到的数据进行持久化成rdb，然后加载到内存中，然后master，在将之前缓存在内存中的命令发送到slave；")]),s._v(" "),t("p",[s._v("当master 与 slave 之间的连接由于某些原因而断开，slave 能自动重连master，如果master收到多个slave 并发连接请求，master 只会进行一次持久化，而不是一个链接一次持久化，然后再把这一份持久化数据发送给多个并发连接的 slave")]),s._v(" "),t("p",[s._v("当 master 和 slave 断开重连后，一般会对整份的数据进行复制，但是从redis 2.8 之后master 和slave 端口后重连支持部分复制。")]),s._v(" "),t("p",[t("strong",[s._v("部分复制的过程：")])]),s._v(" "),t("p",[s._v("master会在其内存中创建一个复制数据用的缓冲队列\n"),t("img",{attrs:{src:"https://ae02.alicdn.com/kf/H4af8ca2f960449bc98b3c223ace8048f4.png",alt:"image.png"}}),s._v(" "),t("img",{attrs:{src:"https://ae03.alicdn.com/kf/H2ef028f3b591457da8019b64c79f546e1.png",alt:"image.png"}})]),s._v(" "),t("h2",{attrs:{id:"主从复制的特点"}},[s._v("主从复制的特点")]),s._v(" "),t("ol",[t("li",[s._v("同一个Master 可以拥有多个Slave")]),s._v(" "),t("li",[s._v("Master 下的Slave 还可以接受同一架构中其他Slave 的连接与同步请求，实现数据的级联复制，即Master -> Slave -> Slave模式")]),s._v(" "),t("li",[s._v("Master 以非阻塞的方式同步数据至Slave，这将意味着Master 会继续处理一个或者多个Slave 的读写请求")]),s._v(" "),t("li",[s._v("主从复制不会阻塞Master，当一个或多个Slave 与 Master进行初次同步数据的时候，Master 可以继续处理客户端发来的请求")]),s._v(" "),t("li",[s._v("主从复制具有可拓展性，即多个Slave 专门提供只读查询与数据的冗余，Master 专门提供写操作")]),s._v(" "),t("li",[s._v("通过配置禁用Master 数据持久化机制，将其数据持久化操作交给Slave完成，避免在Master中有独立的进程来完成此操作")])]),s._v(" "),t("h2",{attrs:{id:"主从复制的优势"}},[s._v("主从复制的优势")]),s._v(" "),t("ul",[t("li",[s._v("避免Redis 单点故障")]),s._v(" "),t("li",[s._v("做到读写分离，构建读写分离架构，满足读多写少的应用场景")])]),s._v(" "),t("h2",{attrs:{id:"docker-搭建-redis-主从集群"}},[s._v("Docker 搭建 Redis 主从集群")]),s._v(" "),t("h3",{attrs:{id:"_1、拉取-redis-镜像"}},[s._v("1、拉取 Redis 镜像")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker pull redis\n")])])]),t("h3",{attrs:{id:"_2、创建文件和文件夹"}},[s._v("2、创建文件和文件夹")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/local/src \n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" redis-cluster  \n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" ./redis-cluster \n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" redis-cluster.conf\n")])])]),t("p",[s._v("向 "),t("code",[s._v("redis-cluster.conf")]),s._v(" 写入 配置如下：")]),s._v(" "),t("div",{staticClass:"language-conf extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("port ${PORT}\ncluster-enabled yes\nprotected-mode no\ncluster-config-file nodes.conf\ncluster-node-timeout 5000\n#对外ip\ncluster-announce-ip [ip] # 修改为你的ip地址\ncluster-announce-port ${PORT}\ncluster-announce-bus-port 1${PORT}\nappendonly yes\n")])])]),t("h3",{attrs:{id:"_3、创建-docker-网络"}},[s._v("3、创建 docker 网络")]),s._v(" "),t("p",[s._v("创建一个 docker 网络，为了 Redis 中的集群通信")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker network create redis-net\n")])])]),t("h3",{attrs:{id:"_4、使用-shell-生成配置信息"}},[s._v("4、使用 shell 生成配置信息")]),s._v(" "),t("p",[s._v("进入到"),t("code",[s._v("redis-cluster")]),s._v("文件夹中")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/local/src/redis-cluster\n")])])]),t("p",[s._v("生成conf和data目录，并生成配置信息")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("port")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6005")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p ./"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${port}")]),s._v("/conf \n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PORT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${port}")]),s._v(" envsubst "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" ./redis-cluster.conf "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ./"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${port}")]),s._v("/conf/redis.conf \n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p ./"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${port}")]),s._v("/data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])])]),t("p",[s._v("生成6个文件夹，从 6000 到 6005 ，每个文件夹下包含data和conf文件夹，同时conf里面有redis.")]),s._v(" "),t("h3",{attrs:{id:"_5、创建-redis-镜像"}},[s._v("5、创建 Redis 镜像")]),s._v(" "),t("p",[s._v("创建 shell 脚本")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" start.sh\n")])])]),t("p",[s._v("编写 shell 脚本如下：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("port")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6005")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" \n  docker run -d -ti -p "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${port}")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${port}")]),s._v(" -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${port}")]),s._v(":1"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${port}")]),s._v(" -v /usr/local/src/redis-cluster/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${port}")]),s._v("/conf/redis.conf:/usr/local/etc/redis/redis.conf -v /usr/local/src/redis-cluster/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${port}")]),s._v("/data:/data  --restart always --name redis-"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${port}")]),s._v(" --net redis-net --sysctl net.core.somaxconn"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" redis redis-server /usr/local/etc/redis/redis.conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])])]),t("p",[s._v("启动容器")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" start.sh\n")])])]),t("p",[s._v("查看容器")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v("\n")])])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"title"}),t("p",[s._v("如果容器的状态为up则，启动成功！否则使用")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v(" docker logs -f --since 30m "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("CONTAINER ID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \n")])])]),t("p",[s._v("来查看日志")])]),t("h3",{attrs:{id:"_6、构建集群"}},[s._v("6、构建集群")]),s._v(" "),t("p",[s._v("进入到任意一个容器")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it CONTAINER ID  /bin/bash\n")])])]),t("p",[s._v("执行")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/local/bin "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" redis-cli --cluster create ip:6000 ip:6001 ip:6002 ip:6003 ip:6004 ip:6005 --cluster-replicas "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"title"}),t("p",[s._v("请确保开放了 "),t("code",[s._v("6000-6005")]),s._v("和"),t("code",[s._v("16000-16005")]),s._v(" 端口\n如果出现 "),t("code",[s._v("waiting for the Cluster to join")]),s._v("，那么应该是你端口没有开放完全。")])]),t("p",[s._v("中途要输入 yes，确认要初始化。")]),s._v(" "),t("h3",{attrs:{id:"查看信息"}},[s._v("查看信息")]),s._v(" "),t("p",[s._v("使用redis-cli进入任一端口")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("redis-cli -h "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" -c -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6000")]),s._v("\n")])])]),t("p",[s._v("查看节点消息")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("cluster nodes\n")])])]),t("p",[s._v("查看集群信息")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("cluster info\n")])])]),t("h2",{attrs:{id:"总结"}},[s._v("总结")]),s._v(" "),t("p",[s._v("记录一下使用服务器搭建Redis集群，后面可能（大概、也许）会搭建一个哨兵模式，下次见！")])])}),[],!1,null,null,null);a.default=r.exports}}]);